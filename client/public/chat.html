<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link rel="stylesheet" href="css/chat.css" type="text/css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>

    </style>
</head>
<body>
    
    <div class="chat-container">
        <nav class="navbar">
            <span style=" height: 65px; width: 400px; text-align: left;">
                <h1>Chat App</h1>
            </span>
            <span>
            <div class="dropdown" style=" width: 150px; height: 30px; text-align: right;">
                <div class="dropdown-content" id="dropdownMenu" style="text-align: center;">
                    <!-- <a href="#">Upload Media</a> -->
                    <a href="#" id="exitRoom">Exit Room</a>
                </div>
                <i class="fas fa-ellipsis-v dots-menu" onclick="toggleDropdown()"></i>
            </div>
        </span>
        </nav>
        <div id="chat-window">
            <div id="output"></div>
            <div id="feedback"></div>
        </div>
        <div class="input-container">
            <input type="text" id="message" placeholder="Enter message...">
            <button id="emoji-button">😀</button> <!-- Emoji button -->
            <button id="send"><i class="fas fa-paper-plane"></i></button>
        </div>
        <div class="emoji-picker" id="emoji-picker" tabindex="0">
            <span class="emoji">😀</span>
            <span class="emoji">😁</span>
            <span class="emoji">😂</span>
            <span class="emoji">🤣</span>
            <span class="emoji">😆</span>
            <span class="emoji add-emoji">➕</span>
        </div>
        <div class="emoji-picker-extended" id="emoji-picker-extended" tabindex="0">
            <span class="emoji">😀</span>
            <span class="emoji">😄</span>
            <span class="emoji">😅</span>
            <span class="emoji">😊</span>
            <span class="emoji">😇</span>
            <span class="emoji">🙂</span>
            <span class="emoji">🙃</span>
            <span class="emoji">😉</span>
            <span class="emoji">😌</span>
            <span class="emoji">😍</span>
            <span class="emoji">🥰</span>
            <span class="emoji">😘</span>
            <span class="emoji">😗</span>
            <span class="emoji">😙</span>
            <span class="emoji">😚</span>
            <span class="emoji">😋</span>
            <span class="emoji">😛</span>
            <span class="emoji">😝</span>
            <span class="emoji">😜</span>
            <span class="emoji">🤪</span>
            <span class="emoji">🤨</span>
            <span class="emoji">🧐</span>
            <span class="emoji">🤓</span>
            <span class="emoji">😎</span>
            <span class="emoji">🥳</span>
            <span class="emoji">🤯</span>
            <span class="emoji">😤</span>
            <span class="emoji">😠</span>
            <span class="emoji">😡</span>
            <span class="emoji">😶</span>
            <span class="emoji">😐</span>
            <span class="emoji">😑</span>
            <span class="emoji">😒</span>
            <span class="emoji">🙄</span>
            <span class="emoji">🤔</span>
            <span class="emoji">🤫</span>
            <span class="emoji">🤭</span>
            <span class="emoji">🤗</span>
            <span class="emoji">😏</span>
            <span class="emoji">😮</span>
            <span class="emoji">😯</span>
            <span class="emoji">😲</span>
            <span class="emoji">🥺</span>
            <span class="emoji">😳</span>
            <span class="emoji">😨</span>
            <span class="emoji">😰</span>
            <span class="emoji">😥</span>
            <span class="emoji">😢</span>
            <span class="emoji">😭</span>
            <span class="emoji">🤤</span>
            <span class="emoji">😴</span>
            <span class="emoji">😪</span>
            <span class="emoji">😵</span>
            <span class="emoji">🥴</span>
            <span class="emoji">🤐</span>
            <span class="emoji">🤧</span>
            <span class="emoji">🤒</span>
            <span class="emoji">🤕</span>
            <span class="emoji">🤑</span>
            <span class="emoji">🤠</span>
            <span class="emoji">😈</span>
            <span class="emoji">👿</span>
            <span class="emoji">👹</span>
            <span class="emoji">👺</span>
            <span class="emoji">🤡</span>
            <span class="emoji">💩</span>
            <span class="emoji">👻</span>
            <span class="emoji">💀</span>
            <span class="emoji">👽</span>
            <span class="emoji">👾</span>
            <span class="emoji">🤖</span>
            <span class="emoji">🎃</span>
            <span class="emoji">😺</span>
            <span class="emoji">😸</span>
            <span class="emoji">😹</span>
            <span class="emoji">😻</span>
            <span class="emoji">😼</span>
            <span class="emoji">😽</span>
            <span class="emoji">🙀</span>
            <span class="emoji">😿</span>
            <span class="emoji">😾</span>
            <span class="emoji">🙌</span>
            <span class="emoji">👏</span>
            <span class="emoji">👋</span>
            <span class="emoji">👍</span>
            <span class="emoji">👎</span>
            <span class="emoji">👊</span>
            <span class="emoji">✊</span>
            <span class="emoji">🤛</span>
            <span class="emoji">🤜</span>
            <span class="emoji">🤞</span>
            <span class="emoji">✌</span>
            <span class="emoji">🤟</span>
            <span class="emoji">🤘</span>
            <span class="emoji">👌</span>
            <span class="emoji">🤏</span>
            <span class="emoji">👈</span>
            <span class="emoji">👉</span>
            <span class="emoji">👆</span>
            <span class="emoji">👇</span>
            <span class="emoji">🖕</span>
            <span class="emoji">☝</span>
            <span class="emoji">🖖</span>
            <span class="emoji">👋</span>
            <span class="emoji">👏</span>
            <span class="emoji">🙌</span>
            <span class="emoji">👐</span>
            <span class="emoji">🤲</span>
            <span class="emoji">🤝</span>
            <span class="emoji">🙏</span>
            <span class="emoji">✍</span>
            <span class="emoji">💅</span>
            <span class="emoji">🤳</span>
            <span class="emoji">💪</span>
            <span class="emoji">🦾</span>
            <span class="emoji">🦵</span>
            <span class="emoji">🦿</span>
            <span class="emoji">🦶</span>
            <span class="emoji">👂</span>
            <span class="emoji">🦻</span>
            <span class="emoji">👃</span>
            <span class="emoji">👀</span>
            <span class="emoji">👁</span>
            <span class="emoji">👅</span>
            <span class="emoji">👄</span>

        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const userId = localStorage.getItem('userId');
        const room = 'room1'; // Both users should have the same room
    
        socket.emit('joinRoom', { userId, room });
    
        const messageInput = document.getElementById('message');
        const output = document.getElementById('output');
        const feedback = document.getElementById('feedback');
        const sendButton = document.getElementById('send');
        const emojiButton = document.getElementById('emoji-button');
        const emojiPicker = document.getElementById('emoji-picker');
        const emojiPickerExtended = document.getElementById('emoji-picker-extended');
        
        const sendMessage = () => {
            if (messageInput.value.trim() !== '') {
                socket.emit('sendMessage', {
                    room,
                    senderId: userId,
                    content: messageInput.value
                });
                messageInput.value = '';
            }
        };

        function exitRoom() {
            if (confirm("Are you sure you want to exit the room?")) {
                socket.emit('leaveRoom', { userId, room });
                window.location.href = 'login.html'; // Navigate to a blank page
                setTimeout(() => {
                    window.close();
                }, 100);
            }
        }

        // Attach event listener to "Exit Room" link
        document.getElementById('exitRoom').addEventListener('click', exitRoom);

        function toggleDropdown() {
            const dropdownMenu = document.getElementById('dropdownMenu');
            dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
        }

        // Close the dropdown menu when clicking outside of it
        window.onclick = function(event) {
            if (!event.target.matches('.dots-menu')) {
                const dropdownMenu = document.getElementById('dropdownMenu');
                if (dropdownMenu.style.display === 'block') {
                    dropdownMenu.style.display = 'none';
                }
            }
        };

        // sendButton.addEventListener('click', sendMessage);
    
        sendButton.addEventListener('click', () => {
            sendMessage();
            emojiPicker.style.display = 'none'; 
            emojiPickerExtended.style.display = 'none'; 
        });


        messageInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
            }
        });
    
        emojiButton.addEventListener('click', () => {
            if (emojiPickerExtended.style.display === 'block') {
                emojiPickerExtended.style.display = 'none';
            } else {
                emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
            }
        });
    
        emojiPicker.addEventListener('click', (event) => {
            if (event.target.classList.contains('emoji')) {
                if (event.target.classList.contains('add-emoji')) {
                    emojiPicker.style.display = 'none';
                    emojiPickerExtended.style.display = 'block';
                } else {
                    messageInput.value += event.target.textContent;
                }
            }
        });

        emojiPicker.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
                emojiPicker.style.display = 'none';
                messageInput.focus();
            }
        });
    
        emojiPickerExtended.addEventListener('click', (event) => {
            if (event.target.classList.contains('emoji')) {
                messageInput.value += event.target.textContent;
            }
        });
        emojiPickerExtended.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                sendMessage();
                emojiPickerExtended.style.display = 'none';
                messageInput.focus(); 
            }
        });
    
        
        socket.on('message', (data) => {
            feedback.innerHTML = '';
            const alignment = data.sender._id === userId ? 'sent' : 'received';
            const userIcon = `<i class="fas fa-user-circle"></i>`;
            const messageContent = data.content;
            const currentTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true }); // Get current time in "hh:mm AM/PM" format
            const userIconBefore = alignment === 'received' ? userIcon : '';
            const userIconAfter = alignment === 'sent' ? userIcon : '';
    
            output.innerHTML += `
                <div class="message ${alignment}">
                    <div class="user-icon-before">
                        ${userIconBefore}
                    </div>
                    <div class="message-content">
                        <div class="bubble">
                            ${messageContent}
                        </div>
                        <div class="current-time">${currentTime}</div> <!-- Display current time -->
                    </div>
                    <div class="user-icon-after">
                        ${userIconAfter}
                    </div>
                </div>`;
                const latestMessage = output.lastElementChild;
                latestMessage.scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });
        });
    </script>
</body>
</html>
